<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel - Bienestar APS</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <!-- Header con usuario logueado -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html">
                      <img src="../assets/images/logo-bienestar.png" alt="Logo Bienestar APS" style="height:120px; width:auto;">
                    </a>
                </div>
                <nav class="user-nav">
                    <div class="user-info">
                        <span class="user-name"></span>
                        <span class="user-rut"></span>
                    </div>
                    <button class="btn btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
                </nav>
            </div>
        </div>
    </header>
    
    <!-- Navegaci√≥n Dashboard -->
    <nav class="dashboard-nav">
        <div class="container">
            <ul class="nav-tabs">
                <li class="nav-tab active" data-tab="resumen">üìä Resumen</li>
                <li class="nav-tab" data-tab="compras-gas">üõí Compra de Gas</li>
                <li class="nav-tab" data-tab="compra-cine">üé¨ Compra de Cine</li>
                <li class="nav-tab" data-tab="compra-jumper">ü§∏ Compra Jumper Park</li>
                <li class="nav-tab" data-tab="compra-gimnasio">üí™ Compra Gimnasio</li>
                <li class="nav-tab" data-tab="prestamos">üí∞ Pr√©stamos y Fondo Solidario</li>
                <li class="nav-tab" data-tab="solicitudes">üìù Solicitudes</li>
                <li class="nav-tab" data-tab="perfil">‚öôÔ∏è Mi Perfil</li>
            </ul>
        </div>
    </nav>
 
    <!-- Contenido del Dashboard -->
    <section class="dashboard-content">
        <div class="container">
            <!-- Tab: Resumen -->
            <div class="tab-content active" id="tab-resumen">
                <div class="welcome-banner">
                    <h1 id="bienvenida-usuario"></h1>
                    <p>Aqu√≠ puedes gestionar tus beneficios y convenios</p>
                </div>
                <div class="stats-grid">
                    <!-- Solicitudes pendientes -->
                    <div class="stat-card">
                        <div class="stat-icon">üìù</div>
                        <div class="stat-info">
                            <h3 id="solicitudes-pendientes"></h3>
                            <p>Solicitudes pendientes</p>
                        </div>
                    </div>

                    <!-- Tiempo de afiliaci√≥n -->
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-info">
                            <h3 id="tiempo-afiliacion"></h3>
                            <p>Tiempo de afiliaci√≥n</p>
                        </div>
                    </div>
                </div>
                <!-- Notificaciones -->
                <div class="section-card">
                    <h2>üîî Notificaciones Recientes</h2>
                    <div class="notifications" id="notificaciones-recientes"></div>
                </div>
            </div>

            <!-- Tab: Compra de Gas -->
            <div class="tab-content" id="tab-compras-gas">
                <h2>üõí Compra de Vales de Gas</h2>
                
                <div class="info-box" style="background: #ed9187; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>üìã Informaci√≥n:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>L√≠mites Mensuales</li>
                        <li>‚ùÑÔ∏è Temporada Normal (Oct-May): M√°ximo 4 cargas mensuales, m√°ximo 2 por tipo</li>
                        <li>üî• Temporada Alta (Jun-Sep): M√°ximo 6 cargas mensuales, m√°ximo 3 por tipo (45kg m√°x. 2)</li>
                    </ul>
                </div>
                
                <!-- Informaci√≥n de Precios -->
                <div class="info-precios-gas" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                    <!-- Precios Lipigas -->
                    <div class="info-box" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">üî•</span> Lipigas
                        </h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">5 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$7.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">11 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$12.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">15 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$16.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">45 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$54.000</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Precios Abastible -->
                    <div class="info-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.3em; display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 1.5em;">‚õΩ</span> Abastible
                        </h3>
                        <div style="display: grid; gap: 10px;">
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">5 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$8.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">11 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$15.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">15 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$18.000</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: rgba(255, 255, 255, 0.2); border-radius: 6px;">
                                <span style="font-weight: 500;">45 kilos:</span>
                                <span style="font-weight: bold; font-size: 1.1em;">$52.000</span>
                            </div>
                        </div>
                    </div>
                </div>

                <form id="formCompraGas" enctype="multipart/form-data">
                    <div class="form-grid">
                        <!-- Informaci√≥n b√°sica -->
                        <div class="form-group">
                            <label for="rutGas">RUT *</label>
                            <input type="text" id="rutGas" name="rutGas" required placeholder="12.345.678-9">
                        </div>
                        <div class="form-group">
                            <label for="nombreGas">Nombre y Apellido Afiliado</label>
                            <input type="text" id="nombreGas" name="nombreGas" required>
                        </div>
                        <div class="form-group">
                            <label for="fechaCompraGas">Fecha de compra</label>
                            <input type="date" id="fechaCompraGas" name="fechaCompraGas" required>
                        </div>
                        <div class="form-group">
                            <label for="emailGas">Correo Electr√≥nico</label>
                            <input type="email" id="emailGas" name="emailGas" required>
                        </div>
                        <div class="form-group">
                            <label for="telefonoGas">Tel√©fono *</label>
                            <input type="tel" id="telefonoGas" name="telefonoGas" required placeholder="+569...">
                        </div>

                        <!-- Selector de empresa -->
                        <div class="form-group">
                            <label>Compra Lipigas</label>
                            <select id="compraLipigas" name="compraLipigas">
                                <option value="no">No</option>
                                <option value="si">S√≠</option>
                            </select>
                        </div>

                        <!-- Opciones Lipigas -->
                        <div id="lipigasOpciones" style="display:none;">
                            <div class="gas-options-container">
                                <div class="gas-option">
                                    <label class="gas-label">5 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="lipigas5" name="lipigas5" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">11 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="lipigas11" name="lipigas11" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">15 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="lipigas15" name="lipigas15" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">45 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="lipigas45" name="lipigas45" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="total-info">Total seleccionado: <span class="total-count">0</span></div>
                        </div>

                        <!-- Selector Abastible -->
                        <div class="form-group">
                            <label>Compra Abastible</label>
                            <select id="compraAbastible" name="compraAbastible">
                                <option value="no">No</option>
                                <option value="si">S√≠</option>
                            </select>
                        </div>

                        <!-- Opciones Abastible -->
                        <div id="abastibleOpciones" style="display:none;">
                            <div class="gas-options-container">
                                <div class="gas-option">
                                    <label class="gas-label">5 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="abastible5" name="abastible5" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">11 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="abastible11" name="abastible11" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">15 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="abastible15" name="abastible15" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="gas-option">
                                    <label class="gas-label">45 kilos</label>
                                    <div class="gas-select-container">
                                        <select id="abastible45" name="abastible45" class="gas-select">
                                            <option value="0">Seleccionar cantidad</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="total-info">Total seleccionado: <span class="total-count">0</span></div>
                            <div class="form-group saldo-favor">
                                <label for="saldoFavor">Saldo a favor (si aplica)</label>
                                <input type="text" id="saldoFavor" name="saldoFavor" placeholder="Fecha y monto">
                            </div>
                        </div>

                        <!-- Comprobante -->
                        <div class="form-group">
                            <label for="comprobanteGas">Adjuntar comprobante de transferencia</label>
                            <input type="file" id="comprobanteGas" name="comprobanteGas" required>
                            <small>Recuerde que el asunto debe indicar cantidad y carga de gas (5k-11k-15k-45k).</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-enviar-gas">Enviar Compra Gas</button>
                </form>
            </div>

            <!-- Tab: Compra de Cine -->
            <div class="tab-content" id="tab-compra-cine">
                <h2>üé¨ Compra de Entradas de Cine</h2>
                <div class="info-box" style="background: #87ceed; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>üìã Informaci√≥n:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>M√°ximo 4 entradas por mes</li>
                        <li>Valor: $7.000 (incluye entrada + combo)</li>
                        <li>V√°lido en cualquier complejo Cin√©polis o Hoyts</li>
                        <li>Incluye pel√≠culas en estreno</li>
                    </ul>
                </div>
                
                <form id="formCompraCine" enctype="multipart/form-data">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rutCine">RUT *</label>
                            <input type="text" id="rutCine" name="rutCine" required placeholder="12.345.678-9">
                        </div>
                        
                        <div class="form-group">
                            <label for="nombreCine">Nombre y Apellido Afiliado *</label>
                            <input type="text" id="nombreCine" name="nombreCine" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="telefonoCine">Tel√©fono *</label>
                            <input type="tel" id="telefonoCine" name="telefonoCine" required placeholder="+569...">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailCine">Correo Electr√≥nico *</label>
                            <input type="email" id="emailCine" name="emailCine" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fechaCompraCine">Fecha de Compra *</label>
                            <input type="date" id="fechaCompraCine" name="fechaCompraCine" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cantidadCine">Cantidad de Entradas *</label>
                            <select id="cantidadCine" name="cantidadCine" required>
                                <option value="0">Seleccione cantidad</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="comprobanteCine">Adjuntar Comprobante de Transferencia *</label>
                            <input type="file" id="comprobanteCine" name="comprobanteCine" required accept="image/*,.pdf">
                            <small>Formatos aceptados: JPG, PNG, PDF</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-enviar-cine">Enviar Compra Cine</button>
                </form>
            </div>  

            <!-- Tab: Compra de Jumper Trampoline Park -->
            <div class="tab-content" id="tab-compra-jumper">
                <h2>ü§∏ Compra de Entradas Jumper Trampoline Park</h2>
                <div class="info-box" style="background: #f0d481; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>üìã Informaci√≥n:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>M√°ximo 6 entradas por mes</li>
                        <li>Valor: $6.500 </li>
                        <li>Diversi√≥n garantizada para toda la familia</li>
                        <li>Incluye acceso a todas las √°reas del parque</li>
                    </ul>
                </div>
                
                <form id="formCompraJumper" enctype="multipart/form-data">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rutJumper">RUT *</label>
                            <input type="text" id="rutJumper" name="rutJumper" required placeholder="12.345.678-9">
                        </div>
                        
                        <div class="form-group">
                            <label for="nombreJumper">Nombre y Apellido Afiliado *</label>
                            <input type="text" id="nombreJumper" name="nombreJumper" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="telefonoJumper">Tel√©fono *</label>
                            <input type="tel" id="telefonoJumper" name="telefonoJumper" required placeholder="+569...">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailJumper">Correo Electr√≥nico *</label>
                            <input type="email" id="emailJumper" name="emailJumper" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fechaCompraJumper">Fecha de Compra *</label>
                            <input type="date" id="fechaCompraJumper" name="fechaCompraJumper" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cantidadJumper">Cantidad de Entradas *</label>
                            <select id="cantidadJumper" name="cantidadJumper" required>
                                <option value="0">Seleccione cantidad</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="comprobanteJumper">Adjuntar Comprobante de Transferencia *</label>
                            <input type="file" id="comprobanteJumper" name="comprobanteJumper" required accept="image/*,.pdf">
                            <small>Formatos aceptados: JPG, PNG, PDF</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-enviar-jumper">Enviar Compra Jumper</button>
                </form>
            </div>

            <!-- Tab: Compra de Gimnasio -->
            <div class="tab-content" id="tab-compra-gimnasio">
                <h2>üí™ Compra de Entradas Gimnasio Energy</h2>
                <div class="info-box" style="background: #a4eb8a; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p><strong>üìã Informaci√≥n:</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>M√°ximo 4 entradas por mes</li>
                        <li>Valor: $18.000 por ticket mensual</li>
                        <li>V√°lido en todas las sucursales Energy</li>
                        <li>Sin restricci√≥n de horarios</li>
                        <li>Incluye todos los servicios</li>
                    </ul>
                </div>
                
                <form id="formCompraGimnasio" enctype="multipart/form-data">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="rutGimnasio">RUT *</label>
                            <input type="text" id="rutGimnasio" name="rutGimnasio" required placeholder="12.345.678-9">
                        </div>
                        
                        <div class="form-group">
                            <label for="nombreGimnasio">Nombre y Apellido Afiliado *</label>
                            <input type="text" id="nombreGimnasio" name="nombreGimnasio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="telefonoGimnasio">Tel√©fono *</label>
                            <input type="tel" id="telefonoGimnasio" name="telefonoGimnasio" required placeholder="+569...">
                        </div>
                        
                        <div class="form-group">
                            <label for="emailGimnasio">Correo Electr√≥nico *</label>
                            <input type="email" id="emailGimnasio" name="emailGimnasio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="fechaCompraGimnasio">Fecha de Compra *</label>
                            <input type="date" id="fechaCompraGimnasio" name="fechaCompraGimnasio" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="cantidadGimnasio">Cantidad de Tickets *</label>
                            <select id="cantidadGimnasio" name="cantidadGimnasio" required>
                                <option value="0">Seleccione cantidad</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="comprobanteGimnasio">Adjuntar Comprobante de Transferencia *</label>
                            <input type="file" id="comprobanteGimnasio" name="comprobanteGimnasio" required accept="image/*,.pdf">
                            <small>Formatos aceptados: JPG, PNG, PDF</small>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-enviar-gimnasio">Enviar Compra Gimnasio</button>
                </form>
            </div>

            <!-- Tab: Pr√©stamos y Fondo Solidario (ya definido m√°s arriba) -->
            <!-- (est√° completamente incluido en la secci√≥n precedente con id="tab-prestamos") -->

            <!-- Tab: Solicitudes -->
            <div class="tab-content" id="tab-solicitudes">
                <h2>üìù Mis Solicitudes</h2>
                <div class="actions-bar">
                    <button class="btn btn-primary" onclick="nuevaSolicitud()">
                        ‚ûï Nueva Solicitud
                    </button>
                </div>
                <div class="solicitudes-list" id="solicitudesListPrestamos"></div>
            </div>

            <!-- Tab: Mi Perfil -->
            <div class="tab-content" id="tab-perfil">
                <h2>‚öôÔ∏è Mi Perfil</h2>
                <div class="profile-grid">
                    <div class="profile-card">
                        <h3>Informaci√≥n Personal</h3>
                        <form class="profile-form">
                            <div class="form-group">
                                <label>Nombre Completo</label>
                                <input type="text" readonly>
                            </div>
                            <div class="form-group">
                                <label>RUT</label>
                                <input type="text" readonly>
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email">
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="tel">
                            </div>
                            <button type="submit" class="btn btn-primary">Actualizar Informaci√≥n</button>
                        </form>
                    </div>
                    <div class="profile-card">
                        <h3>Cambiar Contrase√±a</h3>
                        <form class="profile-form">
                            <div class="form-group">
                                <label>Contrase√±a Actual</label>
                                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <div class="form-group">
                                <label>Nueva Contrase√±a</label>
                                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <div class="form-group">
                                <label>Confirmar Contrase√±a</label>
                                <input type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            </div>
                            <button type="submit" class="btn btn-primary">Cambiar Contrase√±a</button>
                        </form>
                    </div>
                    <div class="profile-card">
                        <h3>Informaci√≥n de Cuenta</h3>
                        <div class="info-list">
                            <div class="info-item">
                                <span class="info-label">Fecha de afiliaci√≥n:</span>
                                <span class="info-value"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Centro de Salud:</span>
                                <span class="info-value"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Cargas familiares:</span>
                                <span class="info-value"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Estado:</span>
                                <span class="badge success"></span>
                            </div>
                        </div>
                        <button class="btn btn-secondary">Ver Cargas Familiares</button>
                    </div>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 Servicio Bienestar APS - Corporaci√≥n Municipal de Puente Alto</p>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script type="module" src="../js/dashboard-afiliado-firebase.js"></script>
    <script type="module" src="../js/compras-unificadas.js"></script>

    <!-- Librer√≠as para generar PDF desde im√°genes -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- M√≥dulos nuevos (aseg√∫rate de tener estos archivos en /js) -->
    <script type="module" src="../js/prestamos-firebase.js"></script>
    <script type="module" src="../js/prestamos.js"></script>

    <script>
    // Sistema de pesta√±as mejorado (mantener estilo)
    const tabs = document.querySelectorAll('.nav-tab');
    const tabContents = document.querySelectorAll('.tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const targetTab = this.getAttribute('data-tab');
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            this.classList.add('active');
            const targetContent = document.getElementById(`tab-${targetTab}`);
            if (targetContent) {
                targetContent.classList.add('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        });
    });

    // Manejo de documentos adicionales seg√∫n tipo de pr√©stamo
    const tipoSelect = document.getElementById('tipoSolicitud');
    if (tipoSelect) {
        tipoSelect.addEventListener('change', function() {
            const documentosAdicionales = document.getElementById('documentosAdicionales');
            const documentosExtrasInfo = document.getElementById('documentosExtrasInfo');
            
            switch(this.value) {
                case 'prestamo-medico':
                    documentosAdicionales.style.display = 'block';
                    documentosExtrasInfo.textContent = 'Informes m√©dicos, cotizaciones de medicamentos o tratamientos';
                    break;
                case 'prestamo-emergencia':
                    documentosAdicionales.style.display = 'block';
                    documentosExtrasInfo.textContent = 'Documentos que respalden la emergencia (facturas, informes, etc.)';
                    break;
                case 'fondo-solidario':
                    documentosAdicionales.style.display = 'block';
                    documentosExtrasInfo.textContent = 'Documentos que respalden la situaci√≥n de emergencia familiar';
                    break;
                case 'prestamo-libre-disposicion':
                    documentosAdicionales.style.display = 'block';
                    documentosExtrasInfo.textContent = 'Cualquier documento adicional que respalde la solicitud';
                    break;
                default:
                    documentosAdicionales.style.display = 'none';
            }
        });
    }

    // Abrir el formulario y preseleccionar tipo cuando se hace click en "Solicitar / Subir documentos"
    document.querySelectorAll('.btn-open-upload').forEach(btn => {
        btn.addEventListener('click', () => {
            const tipo = btn.dataset.tipo || '';
            const tipoMap = {
                medico: 'prestamo-medico',
                emergencia: 'prestamo-emergencia',
                libre_disposicion: 'prestamo-libre-disposicion',
                'libre-disposicion': 'prestamo-libre-disposicion',
                'fondo_solidario': 'fondo-solidario',
                'fondo-solidario': 'fondo-solidario'
            };
            const selectVal = tipoMap[tipo] || '';
            if (selectVal && document.getElementById('tipoSolicitud')) {
                document.getElementById('tipoSolicitud').value = selectVal;
                document.getElementById('tipoSolicitud').dispatchEvent(new Event('change'));
                document.getElementById('formSolicitudPrestamo').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });

    // Exponer image->PDF helper (usa html2canvas + jsPDF)
    async function imageToPDFAndDownload(imageUrl, outFileName = 'formulario.pdf') {
        // crear imagen oculta
        const img = document.createElement('img');
        img.src = imageUrl;
        img.style.position = 'fixed';
        img.style.left = '-9999px';
        document.body.appendChild(img);

        await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = () => reject(new Error('No se pudo cargar la imagen: ' + imageUrl));
        });

        const canvas = await html2canvas(img, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL('image/png');

        const { jsPDF } = window.jspdf;
        // tama√±o en puntos
        const pdf = new jsPDF({
            orientation: canvas.width >= canvas.height ? 'landscape' : 'portrait',
            unit: 'pt',
            format: [canvas.width, canvas.height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save(outFileName);

        document.body.removeChild(img);
    }
    window.imageToPDFAndDownload = imageToPDFAndDownload;

    // Botones descarga (usa el helper anterior)
    document.querySelectorAll('.btn-download-form, .btn-download').forEach(btn => {
        btn.addEventListener('click', async function() {
            const img = this.dataset.img;
            const name = this.dataset.name || (`formulario_${this.dataset.tipo||'prestamo'}.pdf`);
            if (img) {
                try {
                    await imageToPDFAndDownload(img, name);
                } catch (err) {
                    console.error('Error generando PDF, abriendo imagen:', err);
                    window.open(img, '_blank');
                }
            } else {
                // Fallback: si no hay data-img, intentar seleccionar el formulario PNG por tipo
                const tipo = this.dataset.tipo;
                let path = null;
                if (tipo === 'libre_disposicion' || tipo === 'libre-disposicion') path = '../assets/formulario-prestamos-libre-disposicion.png';
                else path = '../assets/formulario-prestamos.png';
                if (path) {
                    try {
                        await imageToPDFAndDownload(path, name);
                    } catch (err) {
                        window.open(path, '_blank');
                    }
                } else {
                    alert('Formulario no disponible para descarga.');
                }
            }
        });
    });

    // Env√≠o del formulario principal de pr√©stamos -> llama al m√≥dulo prestamos-firebase.js
    async function enviarSolicitudHandler(ev) {
        ev.preventDefault();
        const estadoEl = document.getElementById('estadoEnvioGlobal');
        estadoEl.textContent = '‚è≥ Enviando solicitud...';

        const tipoSelect = document.getElementById('tipoSolicitud').value || '';
        const tipoMap = {
            'prestamo-medico': 'medico',
            'prestamo-emergencia': 'emergencia',
            'prestamo-libre-disposicion': 'libre_disposicion',
            'fondo-solidario': 'fondo_solidario'
        };
        const tipo = tipoMap[tipoSelect] || tipoSelect;

        const datos = {
            nombre: document.getElementById('nombrePrestamo').value.trim(),
            rut: document.getElementById('rutPrestamo').value.trim(),
            email: document.getElementById('emailPrestamo').value.trim(),
            telefono: document.getElementById('telefonoPrestamo').value.trim(),
            comentario: document.getElementById('descripcionSolicitud').value.trim(),
            montoSolicitado: document.getElementById('montoSolicitado').value
        };

        const archivos = [];
        const pushFileInput = (inputId) => {
            const input = document.getElementById(inputId);
            if (!input) return;
            if (input.files && input.files.length) {
                for (const f of input.files) archivos.push(f);
            }
        };
        pushFileInput('formularioCompleto');
        pushFileInput('cedulaIdentidad');
        pushFileInput('liquidacionesSueldo');
        pushFileInput('documentosExtras');

        if (!datos.nombre || !datos.rut || !datos.email) {
            estadoEl.textContent = '‚ùå Complete nombre, RUT y correo.';
            return;
        }
        if (!tipo) {
            estadoEl.textContent = '‚ùå Seleccione un tipo de solicitud.';
            return;
        }
        if (archivos.length === 0) {
            estadoEl.textContent = '‚ùå Adjunte al menos un documento requerido.';
            return;
        }

        try {
            // Import din√°mico y llamada
            const module = await import('../js/prestamos-firebase.js');
            if (!module || !module.guardarSolicitudPrestamo) {
                throw new Error('M√≥dulo de Firebase no disponible.');
            }
            const resultado = await module.guardarSolicitudPrestamo(tipo, datos, archivos);
            if (resultado.success) {
                estadoEl.textContent = `‚úÖ Solicitud enviada correctamente. ID: ${resultado.id}`;
                document.getElementById('formSolicitudPrestamo').reset();
                if (window.cargarMisSolicitudesPrestamos) window.cargarMisSolicitudesPrestamos();
            } else {
                estadoEl.textContent = `‚ùå Error: ${resultado.error || 'No definido'}`;
            }
        } catch (err) {
            console.error('Error enviando solicitud:', err);
            estadoEl.textContent = `‚ùå Error inesperado: ${err.message || err}`;
        }
    }

    const formPrestamo = document.getElementById('formSolicitudPrestamo');
    if (formPrestamo) formPrestamo.addEventListener('submit', enviarSolicitudHandler);

    // Funciones globales
    function nuevaSolicitud() {
        document.getElementById('formSolicitudPrestamo').reset();
        document.getElementById('estadoEnvioGlobal').textContent = '';
        document.getElementById('formSolicitudPrestamo').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    function logout() {
        if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
            sessionStorage.clear();
            localStorage.clear();
            window.location.href = '../index.html';
        }
    }
    window.nuevaSolicitud = nuevaSolicitud;
    window.logout = logout;
    </script>

    <style>
        /* Mantener estilos de visibilidad de pesta√±as */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal simple (si se usan modales en prestamos.js) */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items:center; justify-content:center; z-index:9999; }
        .modal.show { display:flex; }

        /* Mantener apariencia consistente de botones usados aqu√≠ */
        .btn-download { background: rgba(0,0,0,0.06); border: 1px solid rgba(0,0,0,0.08); padding:10px 12px; border-radius:8px; cursor:pointer; }
        .btn-open-upload { background: rgba(255,255,255,0.12); border: 1px solid rgba(255,255,255,0.18); padding:10px 12px; border-radius:8px; cursor:pointer; color:inherit; }
    </style>
</body>
</html>
